<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.ChatMapper">

	<insert id="createRoom" parameterType="com.itwillbs.domain.ChatRoomVO" useGeneratedKeys="true" keyProperty="roomId">
		INSERT INTO chat_room (buyer_id, seller_id, product_id)
		VALUES (#{buyerId}, #{sellerId}, #{productId})
	</insert>

	<select id="getMyChatRooms" resultType="com.itwillbs.domain.ChatRoomVO">
		SELECT
			room_id AS roomId,
			buyer_id AS buyerId,
			seller_id AS sellerId,
			product_id AS productId
		FROM chat_room
		WHERE buyer_id = #{userId}
		OR seller_id = #{userId}
	</select>

	<select id="getRoom" resultType="com.itwillbs.domain.ChatRoomVO">
		SELECT
			room_id AS roomId,
			buyer_id AS buyerId,
			seller_id AS sellerId,
			product_id AS productId
		FROM chat_room
		WHERE buyer_id = #{buyerId}
		AND seller_id = #{sellerId}
		AND product_id = #{productId}
	</select>

	<insert id="insertMessage" parameterType="com.itwillbs.domain.ChatMessageVO">
	    INSERT INTO chat_message (room_id, sender_id, message, is_read, created_at)
	    VALUES (#{roomId}, #{senderId}, #{message}, 0, NOW())
	</insert>
	
	<select id="getMessages" resultType="com.itwillbs.domain.ChatMessageVO">
	    SELECT 
	        m.msg_id AS messageId, 
	        m.room_id AS roomId, 
	        m.sender_id AS senderId, 
	        u.name AS senderNick, 
	        m.message, 
	        m.created_at AS sendTime
	    FROM chat_message m
	    JOIN user u ON m.sender_id = u.id
	    WHERE m.room_id = #{roomId}
	    ORDER BY m.created_at ASC
	</select>

	<update id="updateLastMessage">
		UPDATE chat_room
		SET
			last_message = #{message},
			last_message_time = NOW()
		WHERE room_id = #{roomId}
	</update>

</mapper>
